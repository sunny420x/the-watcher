<html>

<head>
    <title>The Watcher - Network Scanner| Sunny420x</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        tr.hidden {
            display: none;
        }

        tr.unhidden {
            display: table-row;
        }
    </style>
</head>

<body>
    <div class="px-5 py-3 text-bg-dark">
        <h2>The Watcher - Network Scanner</h2>
        <p>By Sunny420x</p>
    </div>
    <div class="container my-4">
        <div class="row">
            <div class="col">
                <input type="text" id="query" onchange="search(this.value)" class="form-control">
            </div>
            <div class="col-auto">
                <button onclick="back()" class="btn btn-primary">Previous</button>
            </div>
            <div class="col-auto">
                <button onclick="next()" class="btn btn-primary">Next</button>
            </div>
        </div>
        <div class="form-check mt-2">
            <input class="form-check-input" type="checkbox" value="" id="hiddenFilter"
                onchange="toggleFilter('hidden')">
            <label class="form-check-label" for="hiddenFilter">
                Show unuseful host.
            </label>
        </div>
        <div id="result">
        </div>
    </div>
    <div class="container-fluid overflow-auto" style="width: 100%; height: 800px;" id="wrapper">
        <canvas id="myCanvas">
            Your browser does not support the canvas element.
        </canvas>
    </div>
    <script>
        const canvas = document.getElementById("myCanvas");
        const ctx = canvas.getContext("2d");

        function resizeCanvas() {
            canvas.width = canvas.parentElement.clientWidth + canvas.parentElement.clientWidth / 2;
            canvas.height = canvas.parentElement.clientHeight * 2;


            wrapper.scrollLeft = (wrapper.scrollWidth - wrapper.clientWidth) / 2;
            wrapper.scrollTop  = (wrapper.scrollHeight - wrapper.clientHeight) / 2;
        }

        resizeCanvas();
        window.addEventListener("resize", resizeCanvas);

        // Function to draw a node (circle)
        function drawNode(x, y, radius, color, address) {
            ctx.beginPath(); // Start a new path
            ctx.arc(x, y, radius, 0, Math.PI * 2, true); // Draw a full circle
            ctx.fillStyle = color;
            ctx.fill();
            ctx.stroke();
            ctx.fillStyle = "black";
            ctx.fillText(address, x - radius + 8, y);
        }

        // Function to draw a line between two points (x1, y1) and (x2, y2)
        function drawLine(x1, y1, x2, y2, color, width) {
            ctx.beginPath();
            ctx.moveTo(x1, y1); // Move the "pen" to the start point
            ctx.lineTo(x2, y2); // Draw a line to the end point
            ctx.strokeStyle = color;
            ctx.lineWidth = width;
            ctx.stroke(); // Render the line
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        let i = 0
        let range = "<%=query%>"
        let current = parseInt(range.split('.')[2])
        range = range.split('.')[0] + '.' + range.split('.')[1] + '.'

        const loadingSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid" width="50" height="50" style="shape-rendering: auto; display: block; background: rgba(255, 255, 255, 0); margin: auto; margin-top: 100px;" xmlns:xlink="http://www.w3.org/1999/xlink"><g><circle stroke-dasharray="164.93361431346415 56.97787143782138" r="35" stroke-width="10" stroke="#222222" fill="none" cy="50" cx="50">
            <animateTransform keyTimes="0;1" values="0 50 50;360 50 50" dur="1s" repeatCount="indefinite" type="rotate" attributeName="transform"></animateTransform>
            </circle><g></g></g><!-- [ldio] generated by https://loading.io --></svg>`

        function run(range) {
            fetch(`/run/${range}`).then(res => {
                if (res.ok) {
                    return res.json()
                } else {
                    return "Error"
                }
            }).then(data => {
                document.getElementById('result').innerHTML = data.html
                wrapper = document.getElementById('wrapper')

                nodes = []

                sx = canvas.width / 2;
                sy = canvas.height / 2;

                let centerX = sx;
                let centerY = sy;

                let baseRadius = 150;     // first ring distance
                let ringGap = 120;        // space between rings
                let nodeRadius = 40;

                let nodesPerRing = 12;    // first ring capacity
                let ring = 0;
                let indexInRing = 0;

                data.data.open_ip.forEach((node, index) => {

                    if (indexInRing >= nodesPerRing) {
                        ring++;
                        indexInRing = 0;

                        // increase capacity as ring grows
                        nodesPerRing = Math.floor((2 * Math.PI * (baseRadius + ring * ringGap)) / (nodeRadius * 2.5));
                    }

                    let radius = baseRadius + ring * ringGap;
                    let angle = (2 * Math.PI / nodesPerRing) * indexInRing;

                    let x = centerX + radius * Math.cos(angle);
                    let y = centerY + radius * Math.sin(angle);
                    
                    drawLine(centerX, centerY, x, y, "#bbb", 1);

                    drawNode(
                        x,
                        y,
                        nodeRadius,
                        "#2ecc71",
                        node.host.replace('http://', '')
                    );


                    indexInRing++;
                });

                drawNode(centerX, centerY, 50, "#444", range + ".0/24")
            });
        }

        function next() {
            if (parseInt(range.split('.')[1]) + 1 == 256 && current + 1 == 256) {
                current = 0
                range = parseInt(range.split('.')[0]) + 1 + '.' + '0.';
            } else {
                if (current + 1 == 256) {
                    current = -1;
                    range = range.split('.')[0] + '.' + (parseInt(range.split('.')[1]) + 1) + '.';
                }
            }
            document.getElementById('result').innerHTML = loadingSvg
            run(range + (current += 1)); document.getElementById('query').value = range + current
            history.pushState(null, null, '/' + range + current);

            clearCanvas();

        }

        function back() {
            if (parseInt(range.split('.')[1]) - 1 == -1) {
                current = 256
                range = parseInt(range.split('.')[0]) - 1 + '.' + '255.';
            } else {
                if (current - 1 == -1) {
                    current = 256;
                    range = range.split('.')[0] + '.' + (parseInt(range.split('.')[1]) - 1) + '.';
                }
            }
            document.getElementById('result').innerHTML = loadingSvg
            run(range + (current -= 1)); document.getElementById('query').value = range + current
            history.pushState(null, null, '/' + range + current);

            clearCanvas();
        }

        function initField() {
            document.getElementById('result').innerHTML = loadingSvg

            document.getElementById('query').value = range + current
            run(range + current)
        }

        function search(value) {
            document.getElementById('result').innerHTML = "<br>Loading..."
            run(value);
            range = value.split('.')[0] + '.' + value.split('.')[1] + '.';
            current = parseInt(value.split('.')[2])
            history.pushState(null, null, '/' + value);
        }

        function toggleFilter(option) {
            if (option == "hidden") {
                document.querySelectorAll('.hidden, .unhidden').forEach(row => {
                    row.classList.toggle('hidden');
                    row.classList.toggle('unhidden');
                });
            }
        }

        document.addEventListener("keydown", (event) => {
            if (event.defaultPrevented) {
                return;
            }

            switch (event.key) {
                case "ArrowLeft":
                    back()
                    break;
                case "ArrowRight":
                    next()
                    break;
                default:
                    return;
            }

            event.preventDefault();
        }, true);

        initField()
    </script>
</body>

</html>